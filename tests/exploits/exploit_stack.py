import sys
import os
import sys

# Ensure src is in path
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
src_path = os.path.join(project_root, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

from mem4ristor.core import Mem4ristorV2

def generate_deep_dict(depth):
    """Cr√©e un dictionnaire imbriqu√© profond pour exploser la pile."""
    if depth == 0:
        return "value"
    return {"level": generate_deep_dict(depth - 1)}

def test_recursion_bomb():
    print("üöÄ Lancement de l'attaque Stack Smasher...")
    
    print(f"Recursion Limit: {sys.getrecursionlimit()}")
    # On d√©passe la limite de r√©cursion standard de Python
    depth = sys.getrecursionlimit() + 1000
    print(f"‚öôÔ∏è Construction d'une config mal√©fique de profondeur {depth}...")
    evil_config = {}
    current = evil_config
    for i in range(depth):
        current["level"] = {}
        current = current["level"]
    current["final"] = "boom"

    try:
        print("üí£ Initialisation du mod√®le...")
        model = Mem4ristorV2(config=evil_config)
        print("‚ùå √âchec : La pile a r√©sist√© (limite augment√©e ?).")
        sys.exit(0)
        
    except RecursionError as e:
        print(f"üí• CRASH R√âUSSI (Target 1) : RecursionError dans _deep_merge !\n   Le syst√®me est mort.")
        sys.exit(1)
    except Exception as e:
        print(f"‚ö†Ô∏è Autre erreur : {e}")
        sys.exit(0)

if __name__ == "__main__":
    test_recursion_bomb()
