import sys
import os
import numpy as np

# Ensure src is in path
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
src_path = os.path.join(project_root, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

from mem4ristor.core import Mem4Network

def test_ghost_singularity():
    print("ğŸš€ Lancement de l'attaque Ghost Singularity (Linalg)...")
    
    # On crÃ©e une matrice carrÃ©e valide en forme, mais invalide en fond
    N = 10
    # Matrice "NÃ©ante"
    ghost_matrix = np.full((N, N), np.nan)
    
    try:
        print(f"âš™ï¸ Initialisation du rÃ©seau avec une matrice 'NaN' ({N}x{N})...")
        net = Mem4Network(adjacency_matrix=ghost_matrix)
        
        print("âš™ï¸ Calcul du spectral gap (eigenvalues)...")
        # Ensure we are not using stencil so it calls eigh
        if net.use_stencil:
             print("âš ï¸ Erreur test : Utilise stencil au lieu de matrice.")
             sys.exit(0)

        gap = net.get_spectral_gap()
        
        if np.isnan(gap):
            print("ğŸ’‰ CORRUPTION SILENCIEUSE (Target 2) : Le spectral gap est NaN.")
            sys.exit(1)
        else:
            print(f"âŒ Ã‰chec de l'attaque : Le calcul a rÃ©ussi (Result: {gap}).")
            sys.exit(0)
            
    except (np.linalg.LinAlgError, ValueError) as e:
        if "Adjacency matrix contains NaN" in str(e):
             print(f"ğŸ›¡ï¸ DÃ©fense active (V4 Success) : {e}")
             sys.exit(0)
        print(f"ğŸ’¥ CRASH RÃ‰USSI (Target 1) : Erreur algÃ©brique fatale dans eigh() !\n   DÃ©tail : {e}")
        sys.exit(1)
    except Exception as e:
        print(f"ğŸ’¥ Crash Inattendu : {type(e).__name__} - {e}")
        sys.exit(1)

if __name__ == "__main__":
    test_ghost_singularity()
