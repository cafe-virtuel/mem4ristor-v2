import sys
import os

# Ensure src is in path
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
src_path = os.path.join(project_root, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

from mem4ristor.core import Mem4ristorV2

def test_temporal_void():
    print("üöÄ Lancement de l'attaque Temporal Void...")
    
    # Needs valid N to avoid other errors
    model = Mem4ristorV2(seed=42)
    model._initialize_params(N=10)
    
    # On demande d'int√©grer de t=0 √† t=0.
    # Physiquement, √ßa ne veut rien dire, et math√©matiquement, la solution est vide.
    try:
        print("‚öôÔ∏è Appel de solve_rk45 avec t_span=(0, 0)...")
        sol = model.solve_rk45(t_span=(0, 0), adj_matrix=None) 
        print(f"‚ùå √âchec de l'attaque : Le solver a surv√©cu. Shape: {sol.y.shape}")
        # If shape is (3N, 1), it returned the initial state, which is valid behavior for t=0.
        # But if we try t_span=(0, -1) (Time Reversal), maybe that works?
        # Or t_span where dt is smaller than epsilon?
        sys.exit(0)
        
    except IndexError as e:
        print(f"üí• CRASH R√âUSSI (Target 1) : IndexError lors de la r√©cup√©ration de l'√©tat final !\n   D√©tail : {e}")
        sys.exit(1)
    except ValueError as e:
        # Check if it's our new shape guard or scipy
        if "Shape mismatch" in str(e):
             print("‚ö†Ô∏è Blocked by Shape Guard (Wait, adj_matrix is None?)")
        elif "Invalid time span" in str(e):
             print(f"üõ°Ô∏è D√©fense active (V4 Success) : {e}")
             sys.exit(0)
        elif "t_span" in str(e).lower() or "strictly increasing" in str(e).lower():
            print(f"üõ°Ô∏è D√©fense active : Scipy a bloqu√© l'intervalle invalide.")
            sys.exit(0)
        else:
            print(f"‚ö†Ô∏è Autre ValueError : {e}")
            sys.exit(0)
    except Exception as e:
        print(f"‚ö†Ô∏è Autre erreur : {e}")
        sys.exit(0)

if __name__ == "__main__":
    test_temporal_void()
