import sys
import os
import numpy as np

# Ensure src is in path
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
src_path = os.path.join(project_root, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

from mem4ristor.core import Mem4ristorV2

def attack_negative_time():
    print("üöÄ Lancement de l'attaque Negative Time...")
    
    model = Mem4ristorV2(seed=42)
    model._initialize_params(N=10)
    
    # Attack: Time Travel (Physics Break)
    t_span = (-10.0, -5.0)
    
    try:
        print(f"‚öôÔ∏è Appel de solve_rk45 avec t_span={t_span}...")
        sol = model.solve_rk45(t_span=t_span)
        
        # If we get here, the solver ran.
        # Check if t is actually negative
        if np.any(sol.t < 0):
            print(f"üí• FAIL (Target: Physics Break): Solver accepted negative time! t_min={sol.t.min()}")
            sys.exit(1)
        else:
             print("‚ùå √âchec de l'attaque : Le solver a refus√© ou corrig√© le temps.")
             sys.exit(0)
             
    except ValueError as e:
        if "non-negative" in str(e) or "must be greater than" in str(e): # The latter catches the existing guard if t_start >= t_end
             print(f"üõ°Ô∏è D√©fense active (V6 Success) : {e}")
             sys.exit(0)
        # Any other ValueError is also likely a block/scipy complaint
        print(f"üõ°Ô∏è D√©fense active (Scipy/Other) : {e}") 
        sys.exit(0)
    except Exception as e:
        print(f"‚ö†Ô∏è Autre erreur : {type(e).__name__} : {e}")
        sys.exit(1)

if __name__ == "__main__":
    attack_negative_time()
