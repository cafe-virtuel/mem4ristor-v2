import sys
import os

# Ensure src is in path
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
src_path = os.path.join(project_root, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

from mem4ristor.core import Mem4ristorV2

def attack_entropy_dos():
    print("üöÄ Lancement de l'attaque Entropy DoS...")
    
    # Needs valid init
    model = Mem4ristorV2(seed=42)
    model._initialize_params(N=10)
    
    # 2**31 - 1 is the max signed 32-bit integer. 
    # numpy.histogram creating a dense array of this size will consume GBs of RAM.
    # We use a slightly smaller number to be safe(r) for testing but still huge.
    # 100 Million bins -> 400MB-800MB RAM. Should be enough to prove the point without killing the runner?
    # Claude used 2**31-1 (2147483647). 
    # This WILL attempt to allocate >8GB of RAM.
    evil_bins = 2147483647
    
    try:
        print(f"‚öôÔ∏è Appel de calculate_entropy avec bins={evil_bins}...")
        # use_cognitive_bins=False triggers the legacy path using 'bins' integer
        model.calculate_entropy(bins=evil_bins, use_cognitive_bins=False)
        print("‚ùå √âchec de l'attaque : Le calcul a r√©ussi (ou la machine a surv√©cu).")
        sys.exit(0)
        
    except (MemoryError, ValueError, RuntimeError) as e:
        # MemoryError is a WIN for the attacker (DoS)
        print(f"üí• CRASH R√âUSSI (Target 3 - DoS) : MemoryError ou Crash !\n   D√©tail : {type(e).__name__}: {e}")
        sys.exit(1)
    except Exception as e:
        print(f"‚ö†Ô∏è Autre erreur : {type(e).__name__} : {e}")
        if "maximum allowed" in str(e): # Future proofing
             print("üõ°Ô∏è D√©fense active (V5 Success)")
             sys.exit(0)
        sys.exit(1)

if __name__ == "__main__":
    attack_entropy_dos()
