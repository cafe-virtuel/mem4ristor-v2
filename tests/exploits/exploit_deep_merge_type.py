import sys
import os

# Ensure src is in path
project_root = os.path.abspath(os.path.join(os.path.dirname(__file__), '../../'))
src_path = os.path.join(project_root, 'src')
if src_path not in sys.path:
    sys.path.insert(0, src_path)

from mem4ristor.core import Mem4ristorV2

def attack_deep_merge_type():
    print("üöÄ Lancement de l'attaque Deep Merge Type Confusion...")
    
    # Attack: Pass a string where dict is expected
    # 'coupling' expects a dict {D: float...}
    # We pass a string.
    evil_config = {
        'coupling': 'MALICIOUS_STRING'
    }
    
    try:
        print("‚öôÔ∏è Initialisation du mod√®le avec config type-confusion...")
        model = Mem4ristorV2(config=evil_config)
        # This triggers _validate_config -> self.cfg['coupling'].get(...) -> AttributeError
        
        print("‚ùå √âchec de l'attaque : Le mod√®le a surv√©cu (√©trange).")
        sys.exit(0)
        
    except AttributeError as e:
        print(f"üí• FAIL (Target: Crash): AttributeError non g√©r√©e ! {e}")
        # This is what we want to avoid. We want TypeError or ValueError.
        sys.exit(1)
    except TypeError as e:
         if "expects dict" in str(e):
             print(f"üõ°Ô∏è D√©fense active (V6 Success) : {e}")
             sys.exit(0)
         print(f"‚ö†Ô∏è Autre TypeError : {e}")
         sys.exit(0)
    except Exception as e:
        print(f"‚ö†Ô∏è Autre erreur : {type(e).__name__} : {e}")
        sys.exit(0)

if __name__ == "__main__":
    attack_deep_merge_type()
